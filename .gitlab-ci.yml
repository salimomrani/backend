stages:
  - build
  - docker

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "-B --no-transfer-progress"

# Cache Maven dependencies
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .m2/repository/
    - target/

# Build and test job
build:
  stage: build
  image: eclipse-temurin:17-jdk
  script:
    - echo "Building with Maven..."
    - ./mvnw clean install $MAVEN_CLI_OPTS
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
      - target/*.jar
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "master"'

# Docker build and push job (only on master)
docker:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - export IMAGE_TAG="iconsultingdev/blog-backend:latest"
    - export IMAGE_SHA="iconsultingdev/blog-backend:master-${CI_COMMIT_SHORT_SHA}"
    - echo "Building Docker image..."
    - docker build -t $IMAGE_TAG -t $IMAGE_SHA .
    - echo "Pushing Docker images..."
    - docker push $IMAGE_TAG
    - docker push $IMAGE_SHA
    - echo "Docker images pushed successfully!"
    - echo "  - $IMAGE_TAG"
    - echo "  - $IMAGE_SHA"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  needs:
    - build
